name: "Component Builder Check"
on:
  pull_request:
    paths:
      - 'containers/fedora/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  guest-fedora:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./containers/fedora
    strategy:
      matrix:
        CPU_ARCH: [x86_64, aarch64, s390x]
    env:
      CPU_ARCH: ${{ matrix.CPU_ARCH }}
      FEDORA_VARS_FILE: "fedora-vars"
      PR_NUMBER: ${{ github.event.number }}
      FULL_EMULATION: "true"
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Install dependencies for VM build
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libvirt-daemon-system \
            virtinst cloud-image-utils \
            libguestfs-tools \
            podman
          case "${{ matrix.CPU_ARCH }}" in
            x86_64)
              sudo apt-get install -y qemu-system-x86
              ;;
            aarch64)
              sudo apt-get install -y qemu-system-arm qemu-efi-aarch64
              ;;
            s390x)
              sudo apt-get install -y qemu-system-s390x 
              ;;
          esac
      - name: Tweak hosted runner to enable 'virt-sysprep'
        # https://bugs.launchpad.net/ubuntu/+source/linux/+bug/759725
        run: sudo chmod 0644 /boot/vmlinuz*
      - name: Fetch base Fedora image
        run: |
          set -euo pipefail
          VERS=$(sed -n "s/^FEDORA_VERSION:[[:space:]]\(.*\)/\1/pi" ${{ env.FEDORA_VARS_FILE }})
          URL=$(sed -e "s/\${FEDORA_VERSION}/${VERS}/g" -ne "s/^FEDORA_${{ matrix.CPU_ARCH }}_DOWNLOAD_DIR:[[:space:]]\(.*\)/\1/pi" ${{ env.FEDORA_VARS_FILE }})
          IMAGE=$(sed -n "s/^FEDORA_${{ matrix.CPU_ARCH }}_IMAGE:[[:space:]]\(.*\)/\1/pi" ${{ env.FEDORA_VARS_FILE }})
          echo "FEDORA_VERSION=$VERS" >> $GITHUB_ENV
          wget -q "${URL}/${IMAGE}"
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.6.11"
      - name: Create VM
        env:
          PYTHONPATH: ${{ github.workspace }}
          NO_SECRETS: "true"
        run: ./build.sh
      - name: Save Fedora version and PR number
        run: |
          [[ -f fedora_version ]] || echo ${{ env.FEDORA_VERSION }} > fedora_version
          [[ -f pr_number ]] || echo ${{ env.PR_NUMBER }} > pr_number
      - name: Upload container image artifact
        uses: actions/upload-artifact@v4
        with:
          name: fedora-container-image-${{ matrix.CPU_ARCH }}
          path: |
            containers/fedora/fedora_build/fedora-image-${{ env.FEDORA_VERSION }}-${{ matrix.CPU_ARCH }}.tar
            fedora_version
            pr_number
          retention-days: 5
          compression-level: 0
